<!DOCTYPE html>
<html>
  <head>
    <!-- <link rel="stylesheet" href="style.css"> -->
    <style>
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    #canvas {
      border-spacing: 0;
      border-collapse: collapse;
    }

    #canvas td {
      width: 25px;
      height: 25px;
      border: 1px solid #000;
    }

    .button {
      background: lightgray;
      border: 1px solid;
      color: black;
      padding: 5px 0px;
      width: 10%;
      justify-content: center;
      align-items: center;
      text-align: center;
      display: inline-block;
      font-size: 12px;
      right: 50%;
      transform: translate(0%, 50%);
      margin: 5px;
    }

    .button:hover {
      color:  blue;
    }

    .button:disabled {
      background: none;
      border: 1px solid;
      color: gray;
    }

    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- <script src="script.js" defer></script> -->
  </head>

  <body>
    <table id="canvas"></table>
    <button class="button" id="b" onclick="buttonclick()">Set</button>
    <button class="button" id="l" onclick="createlink()" disabled>Create Link</button>
    <script>
      let canvas = document.querySelector("#canvas");
      var patterns = [];
      var colours = new Array(16).fill("white").map(() => new Array(16).fill("white"));
      var pattern_count = 0;
      var endpoint = "https://www.jsonstore.io/8ba4fd855086288421f770482e372ccb5a05d906269a34da5884f39eed0418a1";


      function logMouseButton(e) {
        if (e.buttons == 1)
          Draw(e.target);
      }

      function GenerateCanvas(sizeX, sizeY) {
        for (let y = 0; y < sizeY; y++) {
          let tr = document.createElement("tr");
          for (let x = 0; x < sizeX; x++) {
            let td = document.createElement("td");
            tr.appendChild(td);
            td.addEventListener("mouseover", logMouseButton);
            td.addEventListener("mousedown", logMouseButton);
          }
          canvas.appendChild(tr);
        }
      }

      function Draw(target) {
        row = $(target).closest("tr").index();
        col = $(target).closest("td").index();

        if (target.style.backgroundColor != "black") {
          target.style.backgroundColor = 'black';
          colours[row][col] = "black";

        } else {
          target.style.backgroundColor = 'white';
          colours[row][col] = "white";
        }
      }

      function buttonclick() {

        if (pattern_count == 0)
        {
          document.getElementById("l").disabled = false;
        }
        
        var grid = [];
        for (var i = 0; i < 16; i++)
        {
          var row = new Array(16).fill(0);;
          for (var j = 0; j < 16; j++)
          {
            if (colours[i][j] == "black")
              row[j] = 1;
          }
          grid.push(row);
        }

        patterns.push(grid);
        pattern_count++;
      
        colours = new Array(16).fill("white").map(() => new Array(16).fill("white"));

        var tabl = document.getElementById("canvas");
        for (var i = 0, row; row = tabl.rows[i]; i++) {
          for (var j = 0, col; col = row.cells[j]; j++) {
            col.style.backgroundColor = "white";
          }
        }
      }

      function choose(choices, leng)
      {
          return choices[Math.floor(Math.random() * leng)];
      }

      function encrypt(patterns)
      {
        mapdict = {0: ['!', 'W', 'a', 'P', 'q'], 1: ['*', 'X', 'b', 'O', 'r'], 2: [';', 'Y', 'c', 'N', 's'], 3: [':', 'Z', 'd', 'M', 't'],
                   4: ['@', '0', 'e', 'L', 'u'], 5: ['&', '1', 'f', 'K', 'v'], 6: ['+', '2', 'g', 'J', 'w'], 7: ['$', '3', 'h', 'I', 'x'],
                   8: ['/', '4', 'i', 'H', 'y'], 9: ['#', '5', 'j', 'G', 'z'], 10: ['[', '6', 'k', 'F', 'Q'], 11: [']', '7', 'l', 'E', 'R'],
                   12: ['.', '8', 'm', 'D', 'S'], 13: ['~', '9', 'n', 'C', 'T'], 14: ['-', '(', 'o', 'B', 'U'], 15: [',', ')', 'p', 'A', 'V']};
        encrypted = ""
        for (i = 0; i < pattern_count; i++)
        {
          sixtyfour = "";
          grid = patterns[i];
          for (rownum = 0; rownum < 16; rownum++)
          {
            four = ""
            for (segnum = 0; segnum < 4; segnum++)
            {
              start = 4 * segnum;
              bin = "";
              for(ind = start; ind < start + 4; ind++)
              {
                bin += patterns[i][rownum][ind];
              }

              character = choose(mapdict[parseInt(bin, 2)], 5);
              four += character;
            }
            sixtyfour += four;
          }

          encrypted += sixtyfour;
        }

        console.log(encrypted);
        return encrypted;

        // // a z - 0
        // // b y - 1
        // // c x - 2
        // // d w - 3
        // // e v - 4
        // // f u - 5
        // // g t - 6
        // // h s - 7
        // // i r - 8
        // // j q - 9
        // // k p 1 4 7 - [
        // // l o 2 5 8 - ]
        // // m n 3 6 9 0 - ,
        // var alphabet = "abcdefghijklmnopqrstuvwxyz";
        // var encrypted = ""
        // for (char = 0; char < json_string.length; char++)
        // {
        //   if (json_string[char] == "[")
        //     encrypted += choose(['k', 'p', '1', '4', '7'], 5);
        //   else if (json_string[char] == "]")
        //     encrypted += choose(['l', 'o', '2', '5', '8'], 5);
        //   else if (json_string[char] == ",")
        //     encrypted += choose(['m', 'n', '3', '6', '9', '0'], 5);
        //   else
        //   {
        //     var val = parseInt(json_string[char]);
        //     encrypted += choose([alphabet[val], alphabet[alphabet.length - 1 - val]], 2);
        //   } 
        // }

        // return encrypted;
      }

      function get_short_url(long_url)
      {
          short_link = "";
          fetch('https://api-ssl.bitly.com/v4/shorten', 
          {
          method: 'POST',
          headers: {
              'Authorization': '0ba35d9befd91b26b5d874d8e5bfae31a725b957',
              'Content-Type': 'application/json'},
          body: JSON.stringify({ "long_url": long_url, "domain": "bit.ly"})
          })
          .then(response => response.json())
          .then(data => {
            short_link = data["link"];
          })
          .catch((error) => {
            console.error('Error:', error);
          });
          return short_link;
      }

      function copyStringToClipboard (str) { // copied from https://techoverflow.net/2018/03/30/copying-strings-to-the-clipboard-using-pure-javascript/
         // Create new element
         var el = document.createElement('textarea');
         // Set value (string to be copied)
         el.value = str;
         // Set non-editable to avoid focus and move outside of view
         el.setAttribute('readonly', '');
         el.style = {position: 'absolute', left: '-9999px'};
         document.body.appendChild(el);
         // Select text inside element
         el.select();
         // Copy text to clipboard
         document.execCommand('copy');
         // Remove temporary element
         document.body.removeChild(el);
      }

      function createlink() 
      {
        var shortened = "";
        var encrypted = encrypt(patterns);
        var link = "https://surabhisnath.github.io/pattern_explorer.html?data=" + encrypted;
        console.log(link);
        try 
        {
          //shortened = get_short_url(link);
          if (shortened == "")
          {
            console.log("Could not shorten URL, using long URL instead");
            shortened = link;
          }
        }
        catch (error)
        {
          console.log("Could not shorten URL, using long URL instead");
          shortened = link;
        }
        console.log(shortened); // will print on console in case doesn't copy
        copyStringToClipboard(shortened);
        document.getElementById("l").innerText = "Link Copied";
        document.getElementById("b").disabled = true;
        document.getElementById("l").disabled = true;
        var tabl = document.getElementById("canvas");
        for (var i = 0, row; row = tabl.rows[i]; i++) {
          for (var j = 0, col; col = row.cells[j]; j++) {
            col.removeEventListener("mouseover", logMouseButton);
            col.removeEventListener("mousedown", logMouseButton);
          }
        }

        //window.document.location = shortened;
      }

      GenerateCanvas(16, 16);
    </script>
  </body>
</html>
<!-- 0ba35d9befd91b26b5d874d8e5bfae31a725b957 -->